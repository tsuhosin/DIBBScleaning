---
title: "07/08/2015 Data Cleaning and Description"
output: html_document
---

```{r, echo=FALSE}
##########################################
# Description of DIBSS survery 0629 data #
##########################################
##update 07/10~07/05/2015 : general data description before data cleaning
##update 07/06/2015 : data cleaning and merge data
##update 07/07/2015 : Run a factor analysis across knowledges sharing inside and outside the group, 
#                     Rename variables according to constructs (see questions, altr, rep, learn, rel),
#                     Run correlation for q13 and 14, individual and across, after that factor analysis (conformative: 4 factors)


setwd("~/Google Drive/DIBBS/DIBBS")
#setwd("~/Google Drive/02 research projects/DIBBS/DIBBS")
#install.packages("xlsx")
#install.packages("pastecs")
#install.packages("prettyR")
#install.packages("psych")
#install.packages("data.table")
library(pastecs)
library(psych)
library(xlsx)
library(prettyR)
library(data.table)
create  <-function(...) paste(substitute(list(...)))[-1] # function for indexing variables



dibbs0<-read.xlsx("NSF_NanoHub_0629_r1.xlsx",1,sheetName="NSF_NanoHub")
### Is it OK? : drop the raw with $Q1=4 // drop the section variables
dibbs<-dibbs0[-which(dibbs0$Q1==4),!names(dibbs0) %in% c("Q6","Q12","Q15","Q46","Q47")]
rownames(dibbs)<-NULL
########################
#treat inverse variables
#########################
dibbs$Q8.1_6<-ifelse(dibbs$Q8.1_6<8,7-dibbs$Q8.1_6,dibbs$Q8.1_6)
dibbs$Q7.1_6<-7-dibbs$Q7.1_6
##################################
#create dummy variable (grouping)#
##################################
## research_usage ##
# if Q4=34, then research_usage=2(non user ; ), otherwise research_usage=1(user)

research<-rep(0,dim(dibbs)[1])
research<-ifelse((dibbs$Q4==34),2,1)

## group ##
# if Q9=1, group=1(group), otherwise research_usage=2(non group) #

group<-rep(0,dim(dibbs)[1])
group<-ifelse((dibbs$Q9==1),1,2)

## combine dummy variable to data ##
dibbs1<-cbind(research,group,dibbs)

###############################
# creating merged varibales #
##############################

## Know_creation ##
# Merge Q7(research=2) & Q8(research=1)
know_cr<-matrix(0,dim(dibbs)[1],6,)
ncc<-character()
for (i in c(1:6)){
  know_cr[,i]<-ifelse(is.na(dibbs[[paste("Q7.1_",i,sep="")]]),dibbs[[paste("Q8.1_",i,sep="")]],dibbs[[paste("Q7.1_",i,sep="")]])
  ncc[i]<-paste("know_cr",i,sep="")
}
as.data.frame(know_cr)
colnames(know_cr)<-ncc
head(know_cr)


###  merge(Q10&Q11_1) or (Q10&Q11_2) ???? ####
## know_sharing_ng vs.know_sharing_ginside ##
cd1<-matrix(0,dim(dibbs)[1],6)
ncd<-c(paste("know_shr_ng.in",c(1:5),sep=""))
for (i in c(1:4,6)){
  for (j in c(6:10)){
    cd1[,i]<-ifelse(is.na(dibbs[[paste("Q10.1_",i,sep="")]]),
                      dibbs[[paste("Q11.1_",j,sep="")]],dibbs[[paste("Q10.1_",i,sep="")]])
  }
}
know_shr_ng.in<-as.data.frame(cd1[,-5])
colnames(know_shr_ng.in)<-ncd
head(know_shr_ng.in)


## know_sharing_ginside vs.know_sharing_goutside ##
cd2<-matrix(0,dim(dibbs)[1],6)
ncd<-c(paste("know_shr_ng.out",c(1:5),sep=""))
for (i in c(1:4,6)){
  for (j in c(6:10)){
    cd2[,i]<-ifelse(is.na(dibbs[[paste("Q10.1_",i,sep="")]]),
                    dibbs[[paste("Q11.1_",j,sep="")]],dibbs[[paste("Q10.1_",i,sep="")]])
  }
}
know_shr_ng.out<-as.data.frame(cd2[,-5])
colnames(know_shr_ng.out)<-ncd
head(know_shr_ng.out)

## 07/07/15: merge Q13 Q14 to  altru,rel,learn,rep ##

ch.nm013<-c(create(Q13.1_8,Q13.1_11,Q13.1_12,Q13.1_13,Q13.1_23,Q13.1_25,Q13.1_26,Q13.1_27,Q13.1_28,Q13.1_29,Q13.1_30,Q13.1_31,Q13.1_32,Q13.1_33))                   
ch.nm014<-c(create(Q14.1_8,Q14.1_11,Q14.1_12,Q14.1_13,Q14.1_23,Q14.1_25,Q14.1_26,Q14.1_27,Q14.1_28,Q14.1_29,Q14.1_30,Q14.1_31,Q14.1_32,Q14.1_33))
ch.nm<-c(create(altru_1,altru_2,altru_3,rep_1,rep_2,rep_3,rel_1,rel_2,rel_3,rel_4,learn_1,learn_2,learn_3,learn_4))

cd3<-matrix(0,dim(dibbs)[1],length(ch.nm013))
ch.nm<-c(create(altru_1,altru_2,altru_3,rep_1,rep_2,rep_3,rel_1,rel_2,rel_3,rel_4,learn_1,learn_2,learn_3,learn_4))
for (k in 1:length(ch.nm013)){
    cd3[,k]<-ifelse(is.na(dibbs[[ch.nm013[k]]]),dibbs[[ch.nm014[k]]],dibbs[[ch.nm013[k]]])
  }
comf<-as.data.frame(cd3)
colnames(comf)<-ch.nm
head(comf)

## reset the group (inside and outside) variable name
setnames(dibbs1,paste("Q11.1_",6:10,sep=""),paste("group.in",1:5,sep=""))
setnames(dibbs1,paste("Q11.2_",6:10,sep=""),paste("group.out",1:5,sep=""))

## combine merged variable to data ##
dibbs1<-cbind(dibbs1, know_cr, know_shr_ng.in, know_shr_ng.out,comf)

head(dibbs1)


########################
# decriptive statistcis 07/05 version#
#######################

stat.desc(dibbs1)
describe(dibbs1,num.desc=c("mean","median","max","var","sd","valid.n"))

#stat.desc(dibbs2)
#describe(dibbs2,num.desc=c("mean","median","max","var","sd","valid.n"))


#########################
# Redefine variables
########################

##===define descrete variables

dsc_var<-c(create(Q4, Q5, Q9, Q17.1_11, Q17.1_12, Q17.1_13, Q17.1_14, Q17.1_15, Q17.2_11, Q17.2_12, Q17.2_13, Q17.2_14, Q17.2_15, Q18.1_10, Q18.1_11, Q18.1_12, Q18.1_13, Q18.1_14, Q19.1_10, Q19.1_11, Q19.1_12, Q19.1_13, Q19.1_14, Q19.2_10, Q19.2_11, Q19.2_12, Q19.2_13, Q19.2_14, Q29_3, Q29_4, Q29_5, Q29_6, Q30, Q31, Q32, Q33, Q34, Q35.1_1, Q35.1_2, Q35.1_3))
text_var<-c(create(Q1_TEXT, Q5_TEXT, Q9_TEXT))


#frequency table and barplot for descrete vairables

for (i in 1:length(dsc_var)) {
  print(freq(dibbs1[dsc_var[i]]))
  barplot(table(dibbs1[dsc_var[i]]),main=dsc_var[i],axes=T,las=3)
}


for (i in 1:length(text_var)) {
 a<-table(dibbs1[text_var[i]])
 print(a)
}


##===define continuous variables

#07/06/15 : Q7~Q12 define con. variables (know_cr, know_shr_ng.in, know_shr_ng.out)
# 07/07/15 : Q13~Q14 define con. variables (comf:dataframe)
con_var<-c(colnames(know_cr), colnames(know_shr_ng.in), colnames(know_shr_ng.out), colnames(comf), create(Q7.1_1, Q7.1_2, Q7.1_3, Q7.1_4, Q7.1_5, Q7.1_6, Q8.1_1, Q8.1_2, Q8.1_3, Q8.1_4, Q8.1_5, Q8.1_6, Q10.1_1, Q10.1_2, Q10.1_3, Q10.1_4, Q10.1_6, Q13.1_8, Q13.1_11, Q13.1_12, Q13.1_13, Q13.1_23, Q13.1_25, Q13.1_26, Q13.1_27, Q13.1_28, Q13.1_29, Q13.1_30, Q13.1_31, Q13.1_32, Q13.1_33, Q14.1_8, Q14.1_11, Q14.1_12, Q14.1_13, Q14.1_23, Q14.1_25, Q14.1_26, Q14.1_27, Q14.1_28, Q14.1_29, Q14.1_30, Q14.1_31, Q14.1_32, Q14.1_33, Q16.1_3, Q16.1_6, Q16.1_7, Q16.1_8, Q16.1_9, Q20.1_33, Q20.1_34, Q20.1_35, Q20.1_36, Q20.1_37, Q20.1_39, Q20.1_40, Q20.1_41, Q21.1_33, Q21.1_34, Q21.1_35, Q21.1_36, Q21.1_37, Q21.1_39, Q21.1_40, Q21.1_41, Q22.1_10, Q22.1_11, Q22.1_12, Q22.1_14, Q22.1_16, Q22.1_18, Q22.1_19, Q22.1_20, Q23.1_10, Q23.1_11, Q23.1_12, Q23.1_13, Q23.1_14, Q23.1_18, Q23.1_19, Q23.1_20, Q23.1_23, Q23.1_25, Q23.1_26, Q23.1_27, Q23.1_28, Q24.1_43, Q24.1_44, Q24.1_45, Q24.1_46, Q25.1_51, Q25.1_52, Q25.1_53, Q25.1_54, Q25.1_55, Q25.1_56, Q26.1_47, Q26.1_48, Q26.1_49, Q26.1_50, Q26.1_51, Q26.1_52, Q26.1_53, Q26.1_54, Q27.1_51, Q27.1_52, Q27.1_53, Q27.1_54, Q28.1_20, Q28.1_22, Q28.1_23, Q28.1_24, Q28.1_25, Q28.1_26, Q28.1_27, Q28.1_28, Q28.1_29))


head(dibbs1)

## describe for continuous variables (tatal & by dummy variable)
# 07/06/15 # 07/07/15
describe(dibbs1[con_var])
describeBy(dibbs1[con_var],dibbs1$research,skew=F, ranges=F)
describeBy(dibbs1[con_var],dibbs1$group,skew=F, ranges=F)






#histogram for continuous variables

for (i in 1:length(con_var)) {
  hist(table(dibbs1[con_var[i]]),main=con_var[i], freq = FALSE, ylim=c(0,0.25))
  curve(dnorm(x, mean=mean(unlist(dibbs1[con_var[i]]), na.rm=TRUE), sd=sd(unlist(dibbs1[con_var[i]]),na.rm=TRUE)), col="blue", lwd=2, add=TRUE)
  lines(density(unlist(dibbs1[con_var[i]]),na.rm=TRUE),col = "red", lwd=2)
}


#################
# Subset data   #
#################

#Subset by research variable#
dibbs1rsc<-dibbs1[research==1,]
dibbs1nrsc<-dibbs1[research==2,]

#Subset by group variable#
dibbs1gr<-dibbs1[group==1,]
dibbs1ngr<-dibbs1[group==2,]


##################
# correlation    #
##################

#colnames(know_cr), colnames(know_shr_ng.in), colnames(know_shr_ng.out),
#dibbs1rsc<-dibbs1[research==1,]
#dibbs1nrsc<-dibbs1[research==2,]

#dibbs1gr<-dibbs1[group==1,]
#dibbs1ngr<-dibbs1[group==2,]


## correlation of knowledge creation variable ##

cor(dibbs1[colnames(know_cr)]) #correlation of whole observation
cor(dibbs1rsc[colnames(know_cr)])#correlation within research group
cor(dibbs1nrsc[colnames(know_cr)])#correlation within nonrearch group

## correlation of knowledge sharing variable ##

##correlation of group variable

#correlation between inside vs. outside 
cor(dibbs1gr[paste("group.in",1:5,sep="")],dibbs1gr[paste("group.out",1:5,sep="")],use="complete")
cor(dibbs1gr[paste("group.in",1:5,sep="")]) #correlation whithin inside
cor(dibbs1gr[paste("group.out",1:5,sep="")],use="complete") #correlation within outside


##correlation of nongroup varaible

cor(dibbs1ngr[paste("Q10.1_",c(1:4,6),sep="")],use="complete") #correlation within group variable


##07/07/15
##correlation of altru,rel,learn,rep

cor(dibbs1[colnames(comf)]) #correlation of whole observation 
cor(dibbs1rsc[colnames(comf)]) #correlation within research group
cor(dibbs1nrsc[colnames(comf)]) #correlation within nonrearch group



##############
## factor analysis
##############

## know_cr

# Determine Number of Factors to Extract
#library(nFactors)
#ev1 <- eigen(cor(know_cr)) # get eigenvalues
#ap1 <- parallel(subject=nrow(know_cr),var=ncol(know_cr),
#               rep=100,cent=.05)
#nS1 <- nScree(x=ev1$values, aparallel=ap1$eigen$qevpea)
#plotnScree(nS1)

# Maximum Likelihood Factor Analysis
# entering raw data and extracting 3 factors, 
# with varimax rotation 
fit1 <- factanal(know_cr, 3, rotation="varimax")
print(fit1, digits=2, cutoff=.3, sort=TRUE)
# plot factor 1 by factor 2 
load1 <- fit1$loadings[,1:2] 
plot(load1,type="p",col=2) # set up plot 
text(load1,labels=colnames(know_cr),cex=.7) # add variable names


## inside 

# Maximum Likelihood Factor Analysis
# entering raw data and extracting 2 factors, 
# with varimax rotation 
fit2 <- factanal(dibbs1gr[paste("group.in",1:5,sep="")], 2, rotation="varimax")
print(fit2, digits=2, cutoff=.3, sort=TRUE)
# plot factor 1 by factor 2 
load2 <- fit2$loadings[,1:2] 
plot(load2,type="p",col=2) # set up plot 
text(load2,labels=colnames(comf),cex=.7) # add variable names

## outside 

# Maximum Likelihood Factor Analysis
# entering raw data and extracting 2 factors, 
# with varimax rotation 
#fit3 <- factanal(dibbs1gr[paste("group.out",1:5,sep="")], 2, rotation="varimax")
#print(fit3, digits=2, cutoff=.3, sort=TRUE)
# plot factor 1 by factor 2 
#load3 <- fit3$loadings[,1:2] 
#plot(load3,type="p",col=2) # set up plot 
#text(load3,labels=colnames(comf),cex=.7) # add variable names


## comf

# Maximum Likelihood Factor Analysis
# entering raw data and extracting 4 factors, 
# with varimax rotation 
fit4 <- factanal(comf, 4, rotation="varimax")
print(fit4, digits=2, cutoff=.3, sort=TRUE)
# plot factor 1 by factor 2 
load4 <- fit4$loadings[,1:2] 
plot(load4,type="p",col=2) # set up plot 
text(load4,labels=colnames(comf),cex=.7) # add variable names
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
